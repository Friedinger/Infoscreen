name: Build and deploy

on:
    push:

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest

        steps:
            - name: Get files
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

            - name: Setup Node.js
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
              with:
                  node-version: 24.11.1
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build project
              run: npm run build

            - name: Output commit hash
              run: |
                  SHORT_HASH=$(echo "${GITHUB_SHA::7}")
                  sed -i "s/{$COMMIT_HASH$}/$SHORT_HASH/g" dist/index.html dist/admin/index.html

            - name: Upload build artifacts
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
              with:
                  name: build-dist
                  path: ./dist/

    deploy:
        name: Deploy
        needs: build
        if: github.ref == github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest

        steps:
            - name: Download build artifacts
              uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
              with:
                  name: build-dist
                  path: ./

            - name: Web deploy
              uses: SamKirkland/web-deploy@8a74c6948a31575b5776ff1e8304d5c2aef5bdbd # v1
              with:
                  target-server: ${{ secrets.TARGET_SERVER }}
                  remote-user: ${{ secrets.REMOTE_USER }}
                  private-ssh-key: ${{ secrets.SSH_KEY }}
                  source-path: ./
                  destination-path: ${{ secrets.DESTINATION_PATH }}
                  rsync-options:
                      --archive --verbose --compress --human-readable --progress --delete-after
                      --exclude=.git/ --exclude=.htaccess --exclude=.htpasswd
                      --exclude=config.json --exclude=news/
